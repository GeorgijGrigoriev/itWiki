$(window).on('load', function(){
    populateFrontpageCards();
    getCategories();
    addNewArticle();
    deleteArticle();
    getCategoriesTable();
    updateArticle();
    addNewCategory();
});

function populateFrontpageCards(){
    $.when(
        $.ajax({
            url: "/api/articles/all",
            dataType: "json"
        })
    ).then(function(succes, fail){
            if (succes.length !== 0){
                $cardRow = $('#itwiki_frontpage_cards');
                for (i=0; i < succes.total; i++){
                    var $postPreview = succes.data[i].post;
                    if (succes.data[i].post.length > 50) $postPreview = $postPreview.substring(0,50);
                    var $clearfix = $('<div />', {
                        id: succes.data[i].article_id
                    }).appendTo($cardRow),
                    $cardBody = $('<div />', {
                        class: "uk-card uk-card-default uk-card-hover uk-card-body",
                        id: succes.data[i].article_id
                    }).appendTo($clearfix),
                    $cardHeader = $('<div />', {
                        class: "uk-card-header"
                    }).appendTo($cardBody),
                    $cardTitle = $('<h3 />', {
                        class: "uk-card-title",
                        text: succes.data[i].title
                    }).appendTo($cardHeader),
                    $cardHtmlBody = $('<div />', {
                        class: "uk-card-body"
                    }).appendTo($cardBody),
                    $cardPost = $('<p />', {
                        text: $postPreview,
                    }).appendTo($cardHtmlBody),
                    $cardFooter = $('<div />', {
                        class: "uk-card-footer",
                        html: "<a href='/read/article/" + succes.data[i].article_id + "' class='uk-button uk-button-text'>Read more</a>"
                    }).appendTo($cardBody);

            }
        }
    });
}


function getCategories(){
    $.when(
        $.ajax({
            url: "/api/categories/get",
            dataType: "json"
        })
    ).then(function(succes, fail){
        var $select = $("#itwiki_autogenerated_select");
        for (var i=0; i<succes.total; i++){
            $option = $('<option />', {
                value: succes.data[i].id,
                text: succes.data[i].category_name
            }).appendTo($select);
        }
    })
}

function getCategoriesTable(){
    $.ajax({
        url: "/api/categories/get",
        dataType: "json",
        complete: function(e){
            var $table = $('#itwiki_category_table'),
            data = (e.responseJSON);
            $table.empty();
            for (i=0; i < e.responseJSON.total; i++){
                $table.append('<tr><td>' + data.data[i].id + '</td>\
                <td>' + data.data[i].category_name + '</td></tr>'
                );
            }
        }
    });
}

function addNewCategory(){
    var $input = $("#itwiki_add_new_category_input"),
    $btn = $("#itwiki_add_new_category");
    $btn.on('click', function(e){
        e.preventDefault();
        $data = $input.serializeArray(),
        $data = indexArray($data),
        $data = JSON.stringify($data);
        console.log($data);
        $.ajax({
            url: "/api/categories/add",
            method: "POST",
            data: $data,
            complete: function(succes){
                getCategoriesTable();
                $("#itwiki_add_new_category_input").empty();
            }
        })
    })
}

function addNewArticle(){
    $articleForm = $('#itwiki_add_new_article');
    $articleForm.on('submit', function(e){
        e.preventDefault();
        var data = $articleForm.serializeArray(),
        data = indexArray(data),
        data = JSON.stringify(data);
        $.when(
            $.ajax({
                url: "/api/articles/add/",
                method: "POST",
                contentType: "application/json",
                dataType: "json",
                data: data
            })
        ).then(function(succes, fail){
            window.location.href = "/";
        })
    });
}

function deleteArticle(){
    var $btn = $('#itwiki_article_settings_delete_article');
    $btn.on('click', function(){
        var $id = $btn.data("id"),
        $url = "/api/articles/delete/" + $id;
        $.ajax({
            url: $url,
            method: "DELETE",
            complete: function(succes){
                window.location.href = "/";
            }
        })
    });
}

function updateArticle(){
    var $btn = $('#itwiki_update_article_button'),
    $form =$("#itwiki_update_article");
    $btn.on('click', function(e){
        e.preventDefault();
        var $id = $btn.data("id"),
        $url = "/api/articles/update/" + $id,
        $data = $form.serializeArray(),
        $data = indexArray($data),
        $data = JSON.stringify($data);
        console.log($data);
        $.ajax({
            url: $url,
            method: "POST",
            data: $data,
            complete: function(succes){
                var $id = succes.responseText;
                window.location.href = "/read/article/" + $id;
            }
        })
    });
}

function indexArray($array) {
    var ua = $array,
    ia = {};
    $.map(ua, function(n, i){
        ia[n['name']] = n['value']
    });
    return ia;
}
